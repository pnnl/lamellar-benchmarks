


use data_structures::*;
use data_structures::distributed::*;
use data_structures::bale::sparsemat as bale;
use tabled::{Table, Tabled};

use lamellar::{LamellarWorld, LamellarWorldBuilder};  
use lamellar::ActiveMessaging;



fn main() {
    

    //  SMALL EXAMPLE
    //  =======================================================
    // println!("stuff stuff stuff");
    // // let numrows = 3; let numcols = 3; let nnz = 3; 
    // let offset = vec![0,1,2,3]; let nonzero = vec![0,1,2];

    // let mut matrix_bale = bale::SparseMat::new(3,3,3);
    // matrix_bale.offset = offset;
    // matrix_bale.nonzero = nonzero;
    // // let matrix_bale = bale::SparseMat{ numrows, numcols, nnz, offset, nonzero, value };
    // let mut rperminv_bale = bale::Perm::new(3); // this generates the length-3 identity permutation
    // let mut cperminv_bale = bale::Perm::new(3); // this generates the length-3 identity permutation

    // let verbose = false;
    // test_permutation(&matrix_bale, &mut rperminv_bale, &mut cperminv_bale, verbose );   
    

    //  ERDOS-RENYI EXAMPLE
    //  =======================================================    
    use rand::Rng;
 
    // parameters to generate the matrix
    let edge_probability        =   0.05;
    let simple                  =   false; // refers to the type of random matrix we generate
    let mut seed: u64;           //=   rand::thread_rng().gen();   <-- could try replacing with this to get randomly generated random seed ... but don't think we want that
    let mut times               =   Vec::new(); // each entry in this vec will store the run times for one execution of matrix perm

    // the world
    let world = LamellarWorldBuilder::new().build();
    let my_pe = world.my_pe();

    // run the tests
    for numrows in (100 .. 1001).step_by(100) {

        seed = numrows as u64;
        // randomly generate a sparse matrix and permutation
        let mut rperminv_bale                =   bale::Perm::random( numrows, seed );
        let mut cperminv_bale                =   bale::Perm::random( numrows, seed );             
        let mut matrix_bale = bale::SparseMat::erdos_renyi_graph(numrows, edge_probability, simple, seed); 
        while   matrix_bale.nonzero.len() == 0 
                || 
                matrix_bale.rowcounts().min().unwrap()==0
        { // re-generate the matrix until it has at least one structural nonzero
            seed += 1;
            matrix_bale = bale::SparseMat::erdos_renyi_graph(numrows, edge_probability, simple, seed); 
        }       
        // println!("BALE MATRIX = {:?}", matrix_bale );

        // test the lamellar implementation of matrix perm
        let verbose = false;
        let verbose_debug = false;
        let measurements = test_permutation( &world, & matrix_bale, &mut rperminv_bale, &mut cperminv_bale, verbose, verbose_debug, );
        
        times.push(measurements);
        world.wait_all();
        world.barrier();
    }    

    if my_pe == 0 {
        let table = Table::new(times.clone()).to_string();
        println!("{}",table.to_string());
        println!("Matrix permutation benchmarks complete.");
    }

}     



// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | numpes | numrows | numcols | nnz   | bale_serial | lamellar_serial | lamellar_dist_total | lamellar_dist_rows | lamellar_dist_colind |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 100     | 100     | 478   | E-6 5.25    | E-6 4.61        | E0 1.99             | E0 1.93            | E-4 9.33             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 200     | 200     | 1998  | E-5 1.23    | E-6 8.07        | E0 2.07             | E0 2.07            | E-3 1.27             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 300     | 300     | 4574  | E-5 3.15    | E-5 1.44        | E0 1.99             | E0 1.99            | E-3 1.80             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 400     | 400     | 8050  | E-5 3.89    | E-5 2.25        | E0 3.59             | E0 3.59            | E-3 2.51             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 500     | 500     | 12620 | E-4 1.11    | E-5 2.89        | E0 8.12             | E0 8.12            | E-3 3.01             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 600     | 600     | 18008 | E-5 8.40    | E-5 3.57        | E0 4.64             | E0 4.64            | E-3 2.81             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 700     | 700     | 24562 | E-4 1.09    | E-5 4.82        | E0 7.95             | E0 7.94            | E-3 4.25             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 800     | 800     | 31798 | E-4 1.42    | E-5 5.62        | E0 9.15             | E0 9.14            | E-3 5.81             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 900     | 900     | 40622 | E-4 2.90    | E-5 6.54        | E0 7.40             | E0 7.39            | E-3 7.95             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 1      | 1000    | 1000    | 49416 | E-4 2.38    | E-5 7.53        | E1 1.12             | E1 1.12            | E-3 9.56             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+


// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | numpes | numrows | numcols | nnz   | bale_serial | lamellar_serial | lamellar_dist_total | lamellar_dist_rows | lamellar_dist_colind |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 100     | 100     | 478   | E-6 5.47    | E-6 4.21        | E-1 3.55            | E-1 2.63           | E-3 1.15             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 200     | 200     | 1998  | E-5 1.68    | E-6 8.68        | E-1 5.55            | E-1 5.53           | E-3 1.35             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 300     | 300     | 4574  | E-5 2.52    | E-5 1.53        | E-1 7.61            | E-1 7.59           | E-3 1.58             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 400     | 400     | 8050  | E-5 3.91    | E-5 2.13        | E0 1.09             | E0 1.09            | E-3 2.28             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 500     | 500     | 12620 | E-5 5.67    | E-5 3.30        | E0 1.80             | E0 1.80            | E-3 2.76             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 600     | 600     | 18008 | E-4 1.05    | E-5 4.38        | E0 1.98             | E0 1.98            | E-3 3.57             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 700     | 700     | 24562 | E-4 1.23    | E-5 4.84        | E0 2.30             | E0 2.29            | E-3 4.37             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 800     | 800     | 31798 | E-4 1.38    | E-5 5.44        | E0 2.29             | E0 2.29            | E-3 3.67             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 900     | 900     | 40622 | E-4 1.94    | E-5 6.63        | E0 2.65             | E0 2.64            | E-3 5.92             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 2      | 1000    | 1000    | 49416 | E-4 2.23    | E-5 7.69        | E0 3.19             | E0 3.18            | E-3 5.75             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+


// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | numpes | numrows | numcols | nnz   | bale_serial | lamellar_serial | lamellar_dist_total | lamellar_dist_rows | lamellar_dist_colind |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 100     | 100     | 478   | E-6 6.01    | E-6 5.16        | E0 1.57             | E0 1.17            | E-2 9.82             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 200     | 200     | 1998  | E-5 1.24    | E-6 9.17        | E-1 6.46            | E-1 6.39           | E-3 2.89             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 300     | 300     | 4574  | E-5 3.31    | E-5 1.60        | E-1 8.55            | E-1 8.48           | E-3 2.69             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 400     | 400     | 8050  | E-5 3.86    | E-5 2.22        | E0 1.38             | E0 1.37            | E-3 2.72             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 500     | 500     | 12620 | E-5 6.04    | E-5 2.91        | E0 2.07             | E0 2.06            | E-3 3.00             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 600     | 600     | 18008 | E-5 9.15    | E-5 3.75        | E0 1.77             | E0 1.76            | E-3 3.13             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 700     | 700     | 24562 | E-4 1.09    | E-5 4.84        | E0 2.31             | E0 2.25            | E-3 3.14             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 800     | 800     | 31798 | E-4 1.40    | E-5 5.67        | E0 2.64             | E0 2.63            | E-3 3.45             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 900     | 900     | 40622 | E-4 1.93    | E-5 6.49        | E0 3.99             | E0 3.98            | E-3 3.97             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+
// | 10     | 1000    | 1000    | 49416 | E-4 2.17    | E-5 7.93        | E0 3.50             | E0 3.49            | E-3 3.64             |
// +--------+---------+---------+-------+-------------+-----------------+---------------------+--------------------+----------------------+